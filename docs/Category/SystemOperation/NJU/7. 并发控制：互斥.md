## äº’æ–¥é—®é¢˜çš„å®šä¹‰å’Œå‡è®¾

å…è®¸ä½¿ç”¨ä½¿æˆ‘ä»¬å¯ä»¥==ä¸ç®¡ä¸€åˆ‡éº»çƒ¦äº‹==çš„åŸå­æŒ‡ä»¤

``` c
void atomic_inc(long *ptr);
int atomic_xchg(int val, int *ptr);
```

!!! tip "å‡½æ•°éœ€è¦åŒ…å«å¦‚ä¸‹åŠŸèƒ½ï¼š"

        - åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤ï¼ˆæŒ‡ä»¤çš„æ‰§è¡Œä¸èƒ½è¢«æ‰“æ–­ï¼‰ï¼›
        - åŒ…å«ä¸€ä¸ª compiler barrierï¼ˆæ— è®ºä½•ç§ä¼˜åŒ–éƒ½ä¸å¯è¶Šè¿‡æ­¤å‡½æ•°ï¼‰ï¼›
        - åŒ…å«ä¸€ä¸ª memory fenceï¼›
            - ä¿è¯å¤„ç†å™¨åœ¨ stop-the-world å‰æ‰€æœ‰å¯¹å†…å­˜çš„ store éƒ½ â€œç”Ÿæ•ˆâ€ï¼›
            - å³å¯¹ resume-the-world ä¹‹åçš„ load å¯è§ï¼›

Atomic Exchange å®ç°ï¼š

``` c
int xchg(int volatile *ptr, int newval) {
  int result;
  asm volatile(
    // æŒ‡ä»¤è‡ªå¸¦ memory barrier
    "lock xchgl %0, %1"
    : "+m"(*ptr), "=a"(result)
    : "1"(newval)
    // Compiler barrier
    : "memory"
  );
  return result;
}
```

## è‡ªæ—‹é” (Spin Lock)

### 1.è‡ªæ—‹é”ï¼šç”¨ xchg å®ç°äº’æ–¥

!!! tip "è‡ªæ—‹é” (Spin Lock)"

        åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡): åˆå§‹æ—¶æ”¾ç€ ğŸ”‘;
        
        æƒ³ä¸Šå•æ‰€çš„åŒå­¦ (ä¸€æ¡ xchg æŒ‡ä»¤):

        - Stop the world
        - çœ‹ä¸€çœ¼æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆ (ğŸ”‘ æˆ– ğŸ›‘)
        - æŠŠ ğŸ›‘ æ”¾åˆ°æ¡Œä¸Š (è¦†ç›–ä¹‹å‰æœ‰çš„ä»»ä½•ä¸œè¥¿)
        - Resume the world
        - æœŸé—´çœ‹åˆ° ğŸ”‘ æ‰å¯ä»¥è¿›å•æ‰€ï¼Œå¦åˆ™é‡å¤

        å‡ºå•æ‰€çš„åŒå­¦: æŠŠ ğŸ”‘ æ”¾åˆ°æ¡Œä¸Š

### 2.å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”

``` c
int table = YES;

void lock() {
retry:
  int got = xchg(&table, NOPE);
  if (got == NOPE)
    goto retry;
  assert(got == YES);
}

void unlock() {
  xchg(&table, YES);  // ä¸ºä»€ä¹ˆä¸æ˜¯ table = YES; ?
}
```
!!! tip "åœ¨ xchg çš„å‡è®¾ä¸‹ç®€åŒ–å®ç°:"

        - åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤
        - åŒ…å«ä¸€ä¸ª compiler barrier
        - åŒ…å«ä¸€ä¸ª memory fence

        ``` c
        int locked = 0;

        void lock() {
            while (xchg(&locked, 1));
        }

        void unlock() {
            xchg(&locked, 0);
        }
        ```